# Docs TODO Summary

**Completed**
- `GAME_PLAN.md`: Define core models for stats and quiet assessment.
- `GAME_PLAN.md`: Implement collectors: host, process, addon, and API middleware stats.
- `GAME_PLAN.md`: Build in-memory stats snapshot and `/api/system-stats/current`.
- `GAME_PLAN.md`: Add SQLite storage for samples and `/api/system-stats/history`.
- `GAME_PLAN.md`: Implement quiet streak tracking and `/api/system-stats/health`.
- `GAME_PLAN.md`: Add scheduler missing pieces: capacity headroom calc, concurrency backstops.
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Define `SystemStatsSnapshot` Pydantic model:
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `collected_at`
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `host` (cpu/mem/disk/net/uptime)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `process` (rss/cpu/fds/threads)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `api` (rps/error_rate/p95_latency) — may be partial in MVP
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `addons` dict keyed by addon_id
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `quiet` (quiet_score + state + reasons)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `errors` (collector errors, optional debug section)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Define addon stats model `AddonStatsSnapshot`:
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: lifecycle/runtime state (installed/enabled/loaded/error if available)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: health status + last_checked + last_ok
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: runtime dir size
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: optional `custom` dict (reserved for addon-provided stats)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Define quiet states: `QUIET`, `NORMAL`, `BUSY`, `PANIC`
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Define `QuietAssessment` model:
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `quiet_score` (0–100)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `state`
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `reasons` list (human readable)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `inputs` summary (cpu_avg_2m, mem_pct, rps, p95, disk_free_pct, etc.)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: CPU: total % + load avg (if available)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Memory: used/free %, swap usage
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Disk: usage per mount (at least `/` and project `data/`)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Network: bytes in/out per interface (optional MVP)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Uptime / boot time
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: RSS memory
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Process CPU %
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Threads
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Open file descriptors (if supported)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: installed/enabled/loaded/runtime state
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: per addon: `data/addons/<id>/runtime` (or actual runtime root)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Implement middleware to record:
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: request count
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: error count
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: latency histogram or rolling p95 approximation
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Expose as in-memory stats for snapshot
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Cooperative scheduling with a **lease** model:
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: addons request a lease, must heartbeat, then release
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: leases expire if heartbeat stops (TTL)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Policy uses current quiet assessment to approve/deny
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Policy uses **capacity** (budget units) to allow multiple low-cost jobs concurrently
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: **No-queue MVP**:
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: scheduler does not hold a backlog
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: callers must retry when denied (guided by `retry_after_sec`)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `HeavyLeaseRequest`:
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `addon_id`
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `job_type`
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `cost_units` (1–100) **canonical cost metric**
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `cost_class` (LOW/NORMAL/HIGH) **legacy / optional** (mapped to units if provided)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `expected_duration_sec` (optional; informational for now)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `priority` (LOW/NORMAL/HIGH) *(API currently expects uppercase values)*
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `constraints`: `cpu_heavy`, `disk_write_heavy`, `network_heavy`
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `HeavyLeaseResponse`:
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `approved` bool
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `lease_id` (if approved)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `retry_after_sec` (if denied)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `limits` (heartbeat TTL guidance)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `reason` (string; should be human-readable and debuggable)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `LeaseRecord`:
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `lease_id / addon_id / job_type`
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `cost_units` (stored for accounting / future auditing)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: timestamps: `granted_at / last_heartbeat_at / expires_at`
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `state`: `active/expired/released` *(member names are lowercase; values are uppercase strings)*
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Hard deny if:
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: quiet_state = PANIC (via quiet assessment)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Soft deny if:
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: quiet_state != QUIET AND priority != HIGH
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: capacity exceeded (units): `used_units + requested_units > capacity_units`
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: optional safety caps: global + per-addon concurrency limits (can remain as backstops)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Default MVP settings (current intent):
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: heartbeat TTL = 30s
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: capacity calculation keeps headroom for the rest of the system (see `calculate_capacity()`)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: concurrency backstops (optional): max_global, max_per_addon
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Denial reasons should be explicit:
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `Capacity exceeded: used=…, requested=…, capacity=…`
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `System is BUSY; waiting for QUIET`
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `Recent PANIC detected; cooling down` (once added)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `POST /api/scheduler/lease/request`
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `POST /api/scheduler/lease/{lease_id}/heartbeat`
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `POST /api/scheduler/lease/{lease_id}/release`
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `GET /api/scheduler/status` (active + recent leases, quiet info)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Add `POST /api/scheduler/lease/{lease_id}/report` (progress + accounting)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Add `POST /api/scheduler/lease/{lease_id}/revoke` (core-initiated cancel)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Track lease lifecycle in-memory (active + recent)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Store derived quiet intervals:
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Provide “last 24h quiet streaks” endpoint or computed on demand
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `GET /api/system-stats/current`
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `GET /api/system-stats/history?group=quiet&range=1h&step=10s`
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `GET /api/system-stats/health` (rollup ok/warn/error + reasons)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Define models for snapshot + quiet assessment
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Build collectors (host/process/addon)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Add API middleware stats
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Implement in-memory snapshot + `/current`
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Implement SQLite sample storage + `/history`
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Add quiet streak tracking + `/health` rollup

**Needs Doing**
- `GAME_PLAN.md`: Add scheduler endpoints: `report` and `revoke`.
- `GAME_PLAN.md`: Persist scheduler lease events and expose per-addon decision summary.
- `GAME_PLAN.md`: Implement queueing: `JobIntent`, queue store, dispatcher, state transitions.
- `GAME_PLAN.md`: Add queue persistence (SQLite) if required for crash safety.
- `GAME_PLAN.md`: Add config model and safe defaults for intervals/thresholds/limits.
- `GAME_PLAN.md`: Add tests: unit for quiet score/policy/token bucket/expiry; integration for snapshot and endpoints.
- `GAME_PLAN.md`: Tackle future enhancements (custom addon stats, downsampling, Prometheus, UI widgets).
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Pull from addon registry/store:
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: health cache entries (status + timestamps + error codes)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Runtime dir size:
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: ensure directory walk is rate-limited / cached
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: optional future: add a priority queue + dispatcher loop (see 3.6)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Persist lease events in SQLite (grant/deny/release/expire)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Expose per-addon decision summary (denies, last reason, cool-down)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Add an internal **priority queue** of job intents (not workers)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: A dispatcher loop periodically re-evaluates admission when:
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Persistence required if we want crash-safe queues (SQLite)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Create DB schema for time-series-ish samples:
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: table `stats_samples`:
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Write samples on a schedule (not every collector run if too frequent)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Retention policy (MVP):
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: keep last 7 days raw (configurable)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: optional downsample later
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Create stats runner on FastAPI startup:
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: collector loops (with jitter)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: each collector isolated with timeout + exception capture
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Suggested intervals (MVP):
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: host/process: 2–5s
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: api aggregation: per request, report every 5s
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: addon health snapshot: 15–60s
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: disk/runtime dir size: 60–120s
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Ensure shutdown cancels tasks cleanly
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `GET /api/system-stats/addons`
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Debug (optional MVP):
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `GET /api/system-stats/debug/collectors`
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Add config model (env + defaults):
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: intervals
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: retention days
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: quiet thresholds (cpu/mem/rps/p95)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: heavy scheduler limits (concurrency, TTL, token bucket)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Provide safe defaults that work on your dev box and on a small NUC
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Unit tests:
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: quiet score calculation
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: policy decisions under simulated stats
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: token bucket behavior
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: lease expiry without heartbeat
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Integration tests:
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: stats runner updates snapshot
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: endpoints return expected structure
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Addon custom stats pull:
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: `GET /api/addons/{id}/stats` (optional endpoint addons may implement)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Downsampling + multi-resolution history
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Prometheus metrics export
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Hard enforcement:
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: cgroups for addon subprocesses
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: container resource limits
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Quiet window prediction heatmap (hour-of-day / day-of-week)
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: UI widgets:
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: header badge: OK/WARN/ERROR
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: sidebar mini chart
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: settings: maintenance window + allow/block toggle
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`: Implement heavy scheduler lease endpoints + policy
- `queueing.md`: Add `JobIntent` model
- `queueing.md`: Add in-memory queue store + endpoints: submit/get/cancel/list
- `queueing.md`: Add dispatcher loop (timer)
- `queueing.md`: Add “dispatchable jobs” endpoint for addon polling:
- `queueing.md`: Add job state transitions + events
- `queueing.md`: Add persistence (SQLite) once semantics are stable

**Source Files Scanned**
- `ARCHITECTURE.md`
- `GAME_PLAN.md`
- `Stats_and_Scheduler_todo_UPDATED_v2_151834.md`
- `capacity_model.md`
- `heartbeat.md`
- `lease_release.md`
- `lease_request.md`
- `queueing.md`
- `scheduler.md`
- `scheduler_queue_api_definitions.md`
- `scheduler_queue_definitions.md`
- `system-metrics.md`
- `worker_lifecycle.md`
